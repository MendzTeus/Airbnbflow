import{X as Y,a1 as ee,V as re,a2 as se,r as i,j as e,G as $,H as te,J as ae,K as oe,M as ie,Q as ne,T as x,a3 as G,a4 as ce,a5 as de,U as le}from"./index-CFBfUQr5.js";import{L as m}from"./label-Cdm9zhvV.js";import{A as pe,C as me,a as ue}from"./alert-BKCop9Vh.js";import{A as he}from"./arrow-left-s31EvzC8.js";import{B as xe}from"./building-acADVoMY.js";function ve(){const y=Y(),{id:A}=ee(),l=!!A,{getPropertyById:L,addProperty:H,updateProperty:X}=re(),{toast:C}=se(),U=i.useRef(null),[t,u]=i.useState({name:"",address:"",city:"",zipCode:"",bedrooms:1,bathrooms:1,imageUrl:"",description:""}),[F,z]=i.useState(""),[J,D]=i.useState(l),[R,I]=i.useState(!1),[B,w]=i.useState(""),[Z,g]=i.useState(""),[q,N]=i.useState(""),[E,P]=i.useState(!1),[T,j]=i.useState([]),[M,k]=i.useState(!1),b=i.useRef(null),h=i.useRef(null);i.useEffect(()=>{if(l){const r=L(A);r?(u(r),z(r.imageUrl||"")):(w("Property not found"),C({variant:"destructive",title:"Error",description:"Property not found."}),y("/properties")),D(!1)}else D(!1)},[A,l,L,y,C]),i.useEffect(()=>{var s;const r=(s=t.zipCode)==null?void 0:s.trim();if(!r||r.length<2){j([]),b.current&&b.current.abort(),h.current&&window.clearTimeout(h.current);return}return h.current&&window.clearTimeout(h.current),h.current=window.setTimeout(async()=>{try{k(!0),g(""),b.current&&b.current.abort();const a=new AbortController;b.current=a;const n=await fetch(`https://api.postcodes.io/postcodes?q=${encodeURIComponent(r)}`,{signal:a.signal});if(!n.ok){j([]),k(!1);return}const c=await n.json(),f=Array.isArray(c==null?void 0:c.result)?c.result.slice(0,8).map(o=>({id:o.postcode,label:`${o.postcode}${o.admin_district?` • ${o.admin_district}`:""}`,postcode:o.postcode,city:o.admin_district||o.parish||o.post_town,region:o.region||o.admin_county,country:o.country})):[];j(f)}catch(a){if((a==null?void 0:a.name)==="AbortError")return;j([])}finally{k(!1)}},400),()=>{h.current&&window.clearTimeout(h.current)}},[t.zipCode]);const v=r=>{const{name:s,value:a}=r.target;u(n=>({...n,[s]:a}))},_=r=>{const{name:s,value:a}=r.target;u(n=>({...n,[s]:parseFloat(a)||0}))},K=r=>{u(s=>({...s,zipCode:r.postcode,city:r.city||s.city,region:r.region||s.region,address:s.address||`${r.postcode}${r.city?`, ${r.city}`:""}${r.region?`, ${r.region}`:""}${r.country?`, ${r.country}`:""}`})),j([]),N(r.city||r.region?`Location selected: ${r.postcode}`:""),g(""),P(!1)},O=async()=>{var n,c;const r=(n=t.zipCode)==null?void 0:n.trim();if(!r)return;g(""),N(""),P(!0);const s=r.replace(/\s+/g,""),a=["GB","US","CA","BR","AU"];for(const f of a)try{const o=await fetch(`https://api.zippopotam.us/${f}/${encodeURIComponent(s)}`);if(!o.ok)continue;const p=await o.json(),d=(c=p==null?void 0:p.places)==null?void 0:c[0];if(!d)continue;u(S=>({...S,city:S.city||d["place name"],address:S.address||`${d["place name"]}, ${d.state||d["state abbreviation"]||""}, ${(p==null?void 0:p.country)||(p==null?void 0:p["country abbreviation"])||f}`.replace(/,\s*,/g,", ").replace(/,\s*$/,""),region:S.region||d.state||d["state abbreviation"]||void 0})),N(`Location found: ${d["place name"]}${d.state?", "+d.state:""}`),P(!1);return}catch{continue}P(!1),g("Unable to find address details for this postal code. Please fill the fields manually.")},Q=r=>{var n;const s=(n=r.target.files)==null?void 0:n[0];if(!s)return;const a=new FileReader;a.onloadend=()=>{const c=a.result;u(f=>({...f,imageUrl:c})),z(c)},a.readAsDataURL(s)},V=()=>{u(r=>({...r,imageUrl:""})),z(""),U.current&&(U.current.value="")},W=async r=>{r.preventDefault(),w(""),I(!0);try{if(!t.name||!t.address||!t.city||!t.zipCode||t.bedrooms===void 0||t.bathrooms===void 0)throw new Error("Please fill in all required fields and ensure bedrooms/bathrooms are numbers.");l?await X(t):await H(t),y("/properties")}catch(s){s instanceof Error?(w(s.message),C({variant:"destructive",title:"Error",description:`Failed to save property: ${s.message}`})):(w("An unexpected error occurred"),C({variant:"destructive",title:"Error",description:"An unexpected error occurred while saving the property."}))}finally{I(!1)}};return J?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"})}):e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs($,{variant:"ghost",onClick:()=>y("/properties"),className:"mb-4",children:[e.jsx(he,{className:"mr-2 h-4 w-4"})," Back to Properties"]}),e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:l?"Edit Property":"Add New Property"}),e.jsx("p",{className:"text-muted-foreground",children:l?"Update the details of your property":"Fill in the details to add a new property"})]}),e.jsx(te,{children:e.jsxs("form",{onSubmit:W,children:[e.jsxs(ae,{children:[e.jsx(oe,{children:l?"Edit Property Details":"Property Details"}),e.jsx(ie,{children:"Enter the basic information about the property"})]}),e.jsxs(ne,{className:"space-y-4",children:[B&&e.jsxs(pe,{variant:"destructive",children:[e.jsx(me,{className:"h-4 w-4"}),e.jsx(ue,{children:B})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"name",children:"Property Name*"}),e.jsx(x,{id:"name",name:"name",value:t.name||"",onChange:v,placeholder:"e.g. Oceanview Apartment",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"address",children:"Street Address*"}),e.jsx(x,{id:"address",name:"address",value:t.address||"",onChange:v,placeholder:"e.g. 123 Main Street",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"city",children:"City*"}),e.jsx(x,{id:"city",name:"city",value:t.city||"",onChange:v,placeholder:"e.g. Miami",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"zipCode",children:"ZIP Code*"}),e.jsx(x,{id:"zipCode",name:"zipCode",value:t.zipCode||"",onChange:r=>{g(""),N(""),v(r)},onBlur:()=>{t.zipCode&&O()},placeholder:"e.g. 33101",required:!0}),M&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-2",children:[e.jsx(G,{className:"h-3 w-3 animate-spin"})," Searching postal codes…"]}),!M&&T.length>0&&e.jsx("div",{className:"mt-2 space-y-1 rounded-md border border-border bg-muted/40 p-2",children:T.map(r=>e.jsx("button",{type:"button",className:"w-full text-left text-xs rounded-sm px-2 py-1 hover:bg-muted transition-colors",onMouseDown:s=>{s.preventDefault(),K(r)},children:r.label},r.id))}),E&&e.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-2",children:[e.jsx(G,{className:"h-3 w-3 animate-spin"})," Looking up address information…"]}),!E&&q&&e.jsx("p",{className:"text-xs text-muted-foreground",children:q}),!E&&Z&&e.jsx("p",{className:"text-xs text-destructive",children:Z})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"bedrooms",children:"Bedrooms*"}),e.jsx(x,{id:"bedrooms",name:"bedrooms",type:"number",min:"0",value:t.bedrooms??0,onChange:_,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"bathrooms",children:"Bathrooms*"}),e.jsx(x,{id:"bathrooms",name:"bathrooms",type:"number",min:"0",step:"0.5",value:t.bathrooms??0,onChange:_,required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"imageUpload",children:"Property Image"}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(x,{id:"imageUpload",type:"file",accept:"image/*",ref:U,onChange:Q}),F&&e.jsx($,{type:"button",variant:"ghost",size:"icon",onClick:V,children:e.jsx(ce,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Upload an image from your device (optional)"})]}),F&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:F,alt:"Property preview",className:"h-40 w-full rounded-md object-cover"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"description",children:"Description"}),e.jsx(de,{id:"description",name:"description",value:t.description||"",onChange:v,placeholder:"Describe the property...",rows:4})]})]}),e.jsxs(le,{className:"flex justify-between",children:[e.jsx($,{type:"button",variant:"outline",onClick:()=>y("/properties"),children:"Cancel"}),e.jsx($,{type:"submit",disabled:R,children:R?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin mr-2 h-4 w-4 border-2 border-background border-t-transparent rounded-full"}),l?"Updating...":"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"mr-2 h-4 w-4"}),l?"Update Property":"Create Property"]})})]})]})})]})}export{ve as default};
